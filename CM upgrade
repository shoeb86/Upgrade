******************************************************
	Cloudera Manager Upgrade (5.7 to 5.9)
******************************************************


* Get the instances ready

* SSH to CM instance

* Set Cm repo

curl https://archive.cloudera.com/cm5/ubuntu/trusty/amd64/cm/cloudera.list > cloudera-manager.list

nano cloudera-manager.list
(change >>  deb https://archive.cloudera.com/cm5/ubuntu/lucid/amd64/cm trusty-cm5 contrib to deb https://archive.cloudera.com/cm5/ubuntu/lucid/amd64/cm trusty-cm5.9.3 contrib)

sudo mv cloudera-manager.list /etc/apt/sources.list.d/

sudo apt-key adv --recv-key --keyserver keyserver.ubuntu.com 327574EE02A818DD

sudo apt-get update

* Install Oracle java

sudo apt-get install oracle-j2sdk1.7 -y

* Install CM server

sudo apt-get install cloudera-manager-daemons cloudera-manager-server

* Start the embedded db

sudo apt-get install cloudera-manager-server-db-2

* Start db

sudo service cloudera-scm-server-db start

* Start CM server

sudo service cloudera-scm-server start

### After installation generate some data on cluster

$ hdfs dfs -mkdir /data

$  yarn jar /opt/cloudera/parcels/CDH/lib/hadoop-mapreduce/hadoop-mapreduce-examples.jar randomwriter  /data/output/



===================================================
		Upgrade starts here
===================================================



-----**** Step 1: Collect Upgrade Information ****-----

Before starting an upgrade, collect the following information:

1. Host credentials. You must have SSH access and be able to log in using a root account or an account that has password-less sudo permission.

2. The version of Cloudera Manager used in your cluster. Go to Support > About.

3. The version of the JDK deployed in the cluster. Go to Support > About.

4. The version of CDH. The CDH version number displays next to the cluster name on the Home page.

5. Whether the cluster was installed using parcels or packages. This information displays next to the CDH version on the Home page of Cloudera Manager.

6. The services enabled in your cluster. Go to Clusters > Cluster name.

7. Operating system type and version. Go to Hosts and click on a hostname in the list. The operating system type and version displays in the Distribution row in the Details section.



-----**** Step 2: Complete Pre-Upgrade Steps ****-----

Read pre-requisite documentation

CDH 5 and Cloudera Manager 5 Requirements and Supported Versions (https://www.cloudera.com/documentation/enterprise/release-notes/topics/rn_consolidated_pcm.html)

Cloudera Manager 5 Release Notes (https://www.cloudera.com/documentation/enterprise/release-notes/topics/rg_release_notes_cm.html)



-----**** Step 3: Back Up Cloudera Manager Databases ****-----


* Stop Cloudera management services 

* Backup CM databases

* To locate information about these databases (database type, hostname, and credentials): SSH to cm host

$ nano  /etc/cloudera-scm-server/db.properties
# Auto-generated by initialize_embedded_db.sh
#
# 20180101-145145
#
# These are database settings for CM Manager
#
com.cloudera.cmf.db.type=postgresql
com.cloudera.cmf.db.host=localhost:7432
com.cloudera.cmf.db.name=scm
com.cloudera.cmf.db.user=scm
com.cloudera.cmf.db.password=hVugcmOwdO

* Run backup command

sudo su
pg_dump -h localhost -p 7432 -U scm > /tmp/scm_server_db_backup.$(date +%Y%m%d)



-----**** Step 4: Upgrade the JDK ****-----

* If JDK upgrade applies then perform.

Upgrading to Oracle JDK 1.8 -> (https://www.cloudera.com/documentation/enterprise/5-11-x/topics/cdh_cm_upgrading_to_jdk8.html#xd_583c10bfdbd326ba-590cb1d1-149e9ca9886--7c46)



-----**** Step 5: Upgrade the Cloudera Manager Server ****-----

* If your cluster is running the embedded PostgreSQL database, stop all services that are using the embedded database. These can include: Hive, Hue, Oozie, Sentry

* Stop the Cloudera Management Service 

* Stop Cloudera Manager Server, Database, and Agent:

Note : Use the Cloudera Manager Admin Console to stop any running commands. 

* On the host running the Cloudera Manager Server, stop the Cloudera Manager Server:

$ sudo service cloudera-scm-server stop

* If you are using the embedded PostgreSQL database with Cloudera Manager, stop the database on the host where the database runs, usually the Cloudera Manager Server host:

$ sudo service cloudera-scm-server-db stop

( Note : If you are not running the embedded database service ,
sudo service cloudera-scm-server-db fast_stop)

*If the Cloudera Manager host is also running the Cloudera Manager Agent, stop the Cloudera Manager Agent:

$ sudo service cloudera-scm-agent stop


* Back up the following directories on the Cloudera Manager server host:
/etc/cloudera-scm-server
/etc/cloudera-scm-agent

$ mkdir cloudera-bu-dirs
$ cp -R /etc/cloudera-scm-agent/ cloudera-bu-dirs/
$ sudo cp -R /etc/cloudera-scm-server/ cloudera-bu-dirs/


* Back up the current Cloudera Manager repo file

$ mkdir repo-bu
$ cp -R /etc/apt/sources.list.d/ repo-bu/


* Download cloudera repo file

curl https://archive.cloudera.com/cm5/ubuntu/trusty/amd64/cm/cloudera.list > cloudera-manager.list

* Upgrade to an specific version of Cloudera Manager:

nano cloudera-manager.list
(change >>  deb https://archive.cloudera.com/cm5/ubuntu/lucid/amd64/cm trusty-cm5 contrib to deb https://archive.cloudera.com/cm5/ubuntu/lucid/amd64/cm trusty-cm5.9.3 contrib)

sudo mv cloudera-manager.list /etc/apt/sources.list.d/

* Run the following command to clean the cache directories and upgrade the software:

sudo apt-get clean

sudo apt-get update

sudo apt-get dist-upgrade

sudo apt-get install cloudera-manager-server cloudera-manager-daemons cloudera-manager-agent

During this process, you might be prompted about your configuration file version:

Configuration file `/etc/cloudera-scm-agent/config.ini'
==> Modified (by you or by a script) since installation.
==> Package distributor has shipped an updated version.
What would you like to do about it ? Your options are:
Y or I : install the package maintainer's version
N or O : keep your currently-installed version
D : show the differences between the versions
Z : start a shell to examine the situation
The default action is to keep your current version.

You will receive a similar prompt for /etc/cloudera-scm-server/db.properties. Answer N to both prompts.

>> For embedded psotgre db
sudo apt-get install cloudera-manager-server-db-2 

* Verify the version of packages installed

$  dpkg-query -l 'cloudera-manager-*'


---*** Start Cloudera Manager Server. ***---

sudo service cloudera-scm-server-db start

sudo service cloudera-scm-server start

(Note : It will take 10-15 mins to start)

* Upgrade the Cloudera Manager Agent using Cloudera Manager



* Note : If you slected to install java in upgrade wizard, then after completion restart cm service

sudo service cloudera-scm-server restart



